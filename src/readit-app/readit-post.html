<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="readit-comment-list-item.html">

<dom-module id="readit-post">
    <template>
    
        <style include="shared-styles iron-flex">
            .post-content {
                padding: var(--spacing-sm);
            }
            iron-image {
                width: 100%;
                height: 400px;
            }
            .overlay {
                position: absolute;
                width: 100vw;
                height: 100vh;
                background: white;
            }
            .overlay .loader {
                @apply --layout-horizontal;
                @apply --layout-center;
                @apply --layout-center-justified;
                height: inherit;
                width: inherit;
            }
        </style>


        <app-route
            route="{{route}}"
            active="{{active}}"
            pattern="/post/:postId"
            data="{{routeData}}"
            tail="{{subroute}}"></app-route>

        <iron-ajax 
            auto="[[active]]"
            url="https://www.reddit.com/comments/[[routeData.postId]]/.json"
            handle-as="json"
            last-response="{{post}}"
            loading="{{loading}}"
        ></iron-ajax>

        <app-header-layout id="layout" has-scrolling-region fullbleed>
          <app-header slot="header" condenses reveals id="header">
                <app-toolbar>
                    <paper-icon-button icon="arrow-back" on-tap="_goBack"></paper-icon-button>
                    <div main-title>[[post.0.data.children.0.data.title]]</div>
                </app-toolbar>
            </app-header>

            <div class="post-content">
                <p>u/[[post.0.data.children.0.data.author]]</p>
                
                <div class="selftext">
                    <marked-element markdown="[[post.0.data.children.0.data.selftext]]"></marked-element>
                </div>
                
                <dom-repeat items="[[post.0.data.children.0.data.preview.images]]" as="image">
                    <template>
                        <div class="image">
                            <iron-image sizing="contain" preload fade src="[[image.source.url]]"></iron-image>
                        </div>
                    </template>
                </dom-repeat>

                <div class="comments">
                    <p>[[post.0.data.children.0.data.num_comments]] comments</p>
                    <dom-repeat items="[[post.1.data.children]]">
                        <template>
                            <readit-comment-list-item comment="[[item]]" class="primary"></readit-comment-list-item>
                        </template>
                    </dom-repeat>
                </div>

            </div>

            
            <div hidden$="[[!loading]]" class="overlay">
                <div class="loader">
                    <paper-spinner-lite active="[[loading]]"></paper-spinner-lite>
                </div>
            </div>

        </app-header-layout>

    </template>
    
    <script>
    class ReaditPost extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { return "readit-post"; }
        _goBack() {
            window.history.back()
        }
    }
    customElements.define(ReaditPost.is, ReaditPost)
    </script>
    
</dom-module>